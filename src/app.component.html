<div class="flex flex-col h-screen bg-transparent w-full max-w-4xl mx-auto">
  @switch (engineState()) {
    @case ('initial') {
      <div class="flex flex-col items-center justify-center h-full p-4">
        <h1 class="text-4xl font-bold mb-2 text-gray-800">Unlimited AI</h1>
        <p class="text-gray-500 mb-8">Select a local model to power your private chat experience.</p>

        <!-- Model Selection -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 w-full max-w-3xl mb-8">
          @for(model of availableModels(); track model.id) {
            <div 
              (click)="selectModel(model)"
              class="relative p-5 rounded-2xl border-2 transition-all duration-200 cursor-pointer"
              [class.bg-blue-500]="selectedModel()?.id === model.id"
              [class.border-blue-500]="selectedModel()?.id === model.id"
              [class.text-white]="selectedModel()?.id === model.id"
              [class.bg-white]="selectedModel()?.id !== model.id"
              [class.border-gray-200]="selectedModel()?.id !== model.id"
              [class.hover:border-blue-400]="selectedModel()?.id !== model.id"
            >
              <span class="absolute top-3 right-3 text-xs font-semibold px-2 py-0.5 rounded-full"
                [class.bg-green-100]="selectedModel()?.id !== model.id && model.performance === 'Fastest'" [class.text-green-800]="model.performance === 'Fastest'"
                [class.bg-yellow-100]="selectedModel()?.id !== model.id && model.performance === 'Balanced'" [class.text-yellow-800]="model.performance === 'Balanced'"
                [class.bg-red-100]="selectedModel()?.id !== model.id && model.performance === 'Most Capable'" [class.text-red-800]="model.performance === 'Most Capable'"
                [class.bg-white/20]="selectedModel()?.id === model.id" [class.text-white]="selectedModel()?.id === model.id"
              >{{ model.performance }}</span>

              <h3 class="font-bold text-lg mb-1 mt-2">{{ model.name }}</h3>
              <p 
                class="text-sm pr-4"
                [class.text-blue-100]="selectedModel()?.id === model.id"
                [class.text-gray-500]="selectedModel()?.id !== model.id"
              >{{ model.description }}</p>
            </div>
          }
        </div>

        <button 
          (click)="initModel()" 
          [disabled]="!selectedModel()"
          class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300 shadow-lg hover:shadow-blue-500/50 disabled:bg-gray-400 disabled:shadow-none disabled:cursor-not-allowed">
          Load Model
        </button>
      </div>
    }
    @case ('loading') {
      <div class="flex flex-col items-center justify-center h-full p-4">
        <h2 class="text-2xl font-semibold mb-4 text-gray-700">Loading {{ selectedModel()?.name }}...</h2>
        <div class="w-full max-w-md bg-gray-200 rounded-full h-4 mb-2 overflow-hidden">
          <div 
            class="bg-blue-600 h-4 rounded-full transition-all duration-300" 
            [style.width.%]="(initProgressReport()?.progress ?? 0) * 100">
          </div>
        </div>
        @if(initProgressReport(); as report) {
           <p class="text-sm text-gray-500 mt-2">{{ report.text }}</p>
        }
      </div>
    }
    @case ('error') {
       <div class="flex flex-col items-center justify-center h-full text-center p-4">
        <h1 class="text-3xl font-bold mb-4 text-red-500">Initialization Error</h1>
        <p class="text-gray-600 mb-8 max-w-md">{{ error() }}</p>
        <button (click)="engineState.set('initial')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300">
          Back to Selection
        </button>
      </div>
    }
    @case ('ready') {
      <header class="flex items-center justify-center p-6 sticky top-0 z-10">
        <div class="flex items-center gap-1 cursor-pointer">
          <span class="font-semibold text-gray-700 text-lg">{{ loadedModelName() }} Chat</span>
        </div>
      </header>

      <main #chatContainer class="flex-1 flex flex-col overflow-y-auto p-4 md:p-6">
          <div class="space-y-8">
            @for (message of messages(); track $index) {
              <div class="flex animate-fadeInUp" [class.justify-end]="message.role === 'user'">
                @if (message.role === 'assistant') {
                  <div class="flex items-start gap-3 max-w-xl lg:max-w-2xl w-full">
                     <div class="flex flex-col items-start w-full">
                        @if (message.aiRole && message.aiRole.name !== 'Assistant') {
                          <div
                            class="px-3 py-1 text-sm font-semibold rounded-t-lg -mb-1 z-[1] self-start ml-4"
                            [style.background-color]="message.aiRole.backgroundColor"
                            [style.color]="message.aiRole.textColor"
                          >
                            {{ message.aiRole.name }}
                          </div>
                        }
                        <div class="ai-response-content-wrapper" [class.role-change-animation]="message.isRoleChangeMessage">
                          <div class="bg-white/60 backdrop-blur-xl border border-white/30 shadow-md p-4 rounded-3xl text-gray-800 leading-relaxed"
                            [class.rounded-tl-lg]="message.aiRole && message.aiRole.name !== 'Assistant'">
                            @if (message.content === '' && isLoading() && $last) {
                              <div class="flex items-center gap-2 p-1">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-blue-500 animate-pulse" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" style="animation-duration: 1.5s;">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M10.333 5.083c.892 -1.232 2.441 -1.232 3.333 0" />
                                    <path d="M18.917 10.333c1.232 .892 1.232 2.441 0 3.333" />
                                    <path d="M13.667 18.917c-.892 1.232 -2.441 1.232 -3.333 0" />
                                    <path d="M5.083 13.667c-1.232 -.892 -1.232 -2.441 0 -3.333" />
                                    <path d="M10.583 10.583l-1.166 -1.166" />
                                    <path d="M13.417 10.583l1.166 -1.166" />
                                    <path d="M13.417 13.417l1.166 1.166" />
                                    <path d="M10.583 13.417l-1.166 1.166" />
                                    <path d="M12 7v-2" />
                                    <path d="M17 12h2" />
                                    <path d="M12 17v2" />
                                    <path d="M7 12h-2" />
                                  </svg>
                                  <span class="text-gray-500 font-medium">Generating response...</span>
                              </div>
                            } @else {
                              <div class="ai-response-content" [innerHTML]="parseMarkdown(message.content)"></div>
                            }
                          </div>
                        </div>
                      </div>
                  </div>
                }
                @if (message.role === 'user') {
                  <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-3xl rounded-br-lg max-w-lg lg:max-w-xl shadow-lg">
                    <p class="whitespace-pre-wrap">{{ message.content }}</p>
                  </div>
                }
              </div>
            }
          </div>

           <!-- Suggested Prompts -->
          @if (messages().at(-1)?.role === 'assistant' && messages().at(-1)?.content && suggestedPrompts().length > 0) {
            <div class="mt-4 animate-fadeInUp max-w-xl lg:max-w-2xl">
              <div class="flex flex-wrap items-start gap-2">
                @for(prompt of suggestedPrompts(); track prompt) {
                  <button 
                    (click)="sendSuggestedPrompt(prompt)" 
                    class="bg-white/60 backdrop-blur-lg border border-gray-200/80 rounded-full px-4 py-2 text-sm text-left text-gray-700 hover:bg-gray-200/60 hover:border-gray-300 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    {{ prompt }}
                  </button>
                }
              </div>
            </div>
          }
      </main>

      <footer class="p-4 sticky bottom-0">
        <div class="flex items-start gap-2 p-2 rounded-full bg-white/40 backdrop-blur-2xl border border-white/30 shadow-lg">
           <button class="w-10 h-10 flex-shrink-0 rounded-full text-gray-500 hover:text-blue-500 hover:bg-black/5 flex items-center justify-center transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.25" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
          </button>
          
          <div class="relative w-full flex-1">
            <!-- Suggestion Overlay -->
            @if(promptSuggestion() && currentPrompt()) {
              <div class="absolute inset-0 py-2.5 px-2 pointer-events-none text-gray-900 leading-tight">
                <span class="invisible whitespace-pre-wrap">{{ currentPrompt() }}</span><!--
             --><span (click)="acceptSuggestion()" class="pointer-events-auto cursor-pointer">
                  <span class="bg-clip-text text-transparent bg-gradient-to-r from-gray-500 to-gray-600 animate-suggestion-in whitespace-pre-wrap">{{ promptSuggestion() }}</span><!--
               --><span class="ml-2 inline-block align-baseline text-xs font-semibold bg-gray-200 text-gray-600 rounded px-1.5 py-0.5 animate-suggestion-in">TAB</span>
                </span>
              </div>
            }

            <textarea 
              #promptInput
              [(ngModel)]="currentPrompt"
              (input)="onInput()"
              (keydown)="onKeydown($event)"
              [disabled]="isLoading()"
              placeholder="Ask anything..." 
              rows="1" 
              class="relative z-10 w-full py-2.5 px-2 bg-transparent focus:ring-0 focus:outline-none resize-none placeholder-gray-500 text-gray-900 leading-tight"
            ></textarea>
          </div>

          <button 
            (click)="handleSendMessage()" 
            [disabled]="isLoading() || !currentPrompt().trim()"
            class="w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center focus:outline-none transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed transform active:scale-95 self-end"
            [class.bg-gradient-to-br]="currentPrompt().trim()"
            [class.from-blue-500]="currentPrompt().trim()"
            [class.to-blue-600]="currentPrompt().trim()"
            [class.hover:shadow-lg]="currentPrompt().trim()"
            [class.hover:shadow-blue-500/50]="currentPrompt().trim()"
            [class.text-white]="currentPrompt().trim()"
            [class.bg-black/5]="!currentPrompt().trim()"
            [class.text-gray-500]="!currentPrompt().trim()"
            >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
              <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
            </svg>
          </button>
        </div>
      </footer>
    }
  }
</div>